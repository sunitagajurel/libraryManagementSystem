<!DOCTYPE html>
<html>
<head>
  <title>Universal Library</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel = "stylesheet" type="text/css" href="style.css">  
</head>
<body>
  <header>
    <h1>Welcome to the Universal Library</h1>
  </header>

  <nav>
    <ul>
      <li><a href="#">Home</a></li>
      <li><a href="#">Books</a></li>
      <li><a href="#">Magazines</a></li>
      <li > OutofStock </li>
      <li onclick="openForm()">ReturnBook</li>
    </ul>
  </nav>

  </style>
</head>
<body>
  <main>
    <div class="search-box">
      <input type="text" name="bookname" placeholder="Book Name" id="bookname">
      <input type="text" name="author" placeholder="Author" id="author">
      <select name="genre" id="genre">
          <option value="">genre</option>
          <!-- <option value="fantasy">Fantasy</option> -->
          <option value="Fiction">Fiction </option>
          <option value="Adventure">Adventure</option>
          <option value="Classic">Classic</option>
          <option value="Fantasy">Fantasy</option>
          <option value="Dystopian">Dystopian</option>
      </select>
      <input type="submit" value="Search" id="searchBtn">
    </div>
    <div class="result-box" id="resultContainer">
    </div>
  </main>

  <div class = "form-popup" id = "return-form"> 
    <form  action = "/return"  method ="post" class = "form-container"> 
      <h1 class="ret-header"> Return Book </h1>
      <label for = "tid">
        <input type = "text" placeholder = "Enter transaction" name="tid" - required> 
      </label>
      <label for = "bid">
        <input type = "text" placeholder = "Enter Bookid" name = "bid" required> 
      </label>
      <button type = "submit" class = "btn " id = "ret-btn" > Return</button>
      <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
  </form>
  </div>


  <div class = "form-popup" id = "borrow-form"> 
    <form class = "form-container"> 
      <h1 class="ret-header"> Borrow Book </h1>
      <label for = "uid">
        <input type = "text" placeholder = "Enter your Id" id = "uid" name="uid" - required> 
      </label>
      <button type = "button" class = "btn" id = "brrBtn" > Borrow</button>
      <button type="button" class="btn cancel" onclick="closeBrrForm()">Close</button>
  </form>
  </div>


  <footer>
    <p>&copy; 2023 Universal Library. Prepared by <i> DARIYA  DIVYA  SUNITA </i></p>
  </footer>

  <script>
    //keeps track of clicked bookId 
    bookId = null

    //opens the popup for borrowing 
    function openBrrForm(bookId) {
      document.getElementById("borrow-form").style.display = "block"; 
   }

    //close the popup for borrowing 
    function closeBrrForm() {
      document.getElementById("borrow-form").style.display = "none";
    }

    //open  the popup for returning 
    function openForm() {
    document.getElementById("return-form").style.display = "block";
   }

   //close the popup for returning
    function closeForm() {
      document.getElementById("return-form").style.display = "none";
    }

    //jquery starts here
    $(document).ready(() => {
      //handles search function 
      $('#searchBtn').click(() => {
        console.log('Button clicked');
        const bookName = $('#bookname').val();
        const author = $('#author').val();
        const genre = $('#genre').val();
        searchBooks(bookName, author, genre);
      });

      //called when burrow button is called on popup
      $('#brrBtn').click(() => {
        const uId = parseInt($('#uid').val());
        Authorise(bookId,uId)
      });

      //called when burrow button is called from bookList
      $('#resultContainer').on('click', '.brw', function() {
       
        bookId = $(this).closest('div.book').data('book-id');
        openBrrForm()
      });

      function searchBooks(bookName, author, genre) {
        console.log('Search book with name:' + bookName + author + genre);
        $('#resultContainer').empty();
        $.ajax({
          url: `/search`,
          method: 'GET',
          data: { 
            "bookName": bookName, 
            "author": author, 
            "genre": genre
          },
          success: function(response) {
            //handles empty search 
            if(response ==="book not found"){
              var bookHtml =  " <h1> Sorry No books found </h1>"
            }
            else{
              var books = response;
              var bookHtml = '<h2>Book Details:</h2>';
              for (let i = 0; i < books.length; i++) {
                  bookHtml += '<div class="book" data-book-id="' + books[i].bookid + '">';
                  bookHtml += '<h3>Title: ' + books[i].bookName + '</h3>';
                  bookHtml += '<p>Author: ' + books[i].author + '</p>';
                  bookHtml += '<p>Genre: ' + books[i].genre + '</p>';
                  bookHtml += '<p>Rating: ' + books[i].rating + '</p>';
                  bookHtml += `<button  class="brw">Borrow </button> </div> `;
              }
            }
            
            $('#resultContainer').html(bookHtml);
          },
          error: function(xhr, status, error) {
            console.error('Error:', error);
          }
        });
      }

      function Authorise(bookId,uId){
        console.log(bookId,uId)
        closeBrrForm()

           $.ajax({
          url: `/borrow`,
          method: 'GET',
          data: { 
            "uId": uId, 
            "bookId":bookId
          },
          success: function(response) {

            alert(response)
          }
        
      })
      }
    })
    
  </script>
 
</body>
</html>
